---
# Playbook 02: Install K3s cluster (master + workers)
- name: Install K3s server on master node
  hosts: k3s_master
  become: true
  gather_facts: true
  
  tasks:
    - name: Display master node information
      debug:
        msg: "Installing K3s server on {{ inventory_hostname }} ({{ ansible_host }})"
    
    - name: Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_binary
    
    - name: Download K3s installation script
      get_url:
        url: "{{ k3s_install_script_url }}"
        dest: /tmp/k3s-install.sh
        mode: '0755'
      when: not k3s_binary.stat.exists
    
    - name: Create K3s config directory
      file:
        path: "{{ k3s_config_dir }}"
        state: directory
        mode: '0755'
    
    - name: Create K3s server config file
      copy:
        content: |
          cluster-cidr: {{ k3s_server_config.cluster_cidr | default('10.42.0.0/16') }}
          service-cidr: {{ k3s_server_config.service_cidr | default('10.43.0.0/16') }}
          disable:
            - traefik
          write-kubeconfig-mode: "0644"
        dest: "{{ k3s_config_dir }}/config.yaml"
        mode: '0644'
    
    - name: Install K3s server
      shell: |
        INSTALL_K3S_VERSION={{ k3s_version }} \
        /tmp/k3s-install.sh server {{ k3s_server_options | join(' ') }}
      args:
        creates: /usr/local/bin/k3s
      register: k3s_install
      changed_when: k3s_install.rc == 0
    
    - name: Wait for K3s to be ready
      shell: k3s kubectl get nodes
      register: k3s_ready
      until: k3s_ready.rc == 0
      retries: 30
      delay: 10
      changed_when: false
    
    - name: Get K3s node token
      slurp:
        src: "{{ k3s_data_dir }}/server/node-token"
      register: k3s_token_file
    
    - name: Set K3s token as fact
      set_fact:
        k3s_token: "{{ k3s_token_file.content | b64decode | trim }}"
    
    - name: Display K3s token (for debugging)
      debug:
        msg: "K3s token: {{ k3s_token }}"
      when: ansible_verbosity >= 1
    
    - name: Get K3s server status
      shell: k3s kubectl get nodes -o wide
      register: k3s_nodes
      changed_when: false
    
    - name: Display K3s nodes
      debug:
        var: k3s_nodes.stdout_lines
    
    - name: Create directory for kubeconfig
      file:
        path: "{{ lookup('env', 'HOME') }}/.kube"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: false
    
    - name: Fetch kubeconfig from master
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ lookup('env', 'HOME') }}/.kube/config-k3s-local"
        flat: true
    
    - name: Update kubeconfig server address
      replace:
        path: "{{ lookup('env', 'HOME') }}/.kube/config-k3s-local"
        regexp: 'https://127\.0\.0\.1:6443'
        replace: "https://{{ ansible_host }}:6443"
      delegate_to: localhost
      become: false
    
    - name: Display kubeconfig location
      debug:
        msg: "Kubeconfig saved to {{ lookup('env', 'HOME') }}/.kube/config-k3s-local"

- name: Install K3s agent on worker nodes
  hosts: k3s_workers
  become: true
  gather_facts: true
  
  vars:
    k3s_master_ip: "{{ hostvars[groups['k3s_master'][0]]['ansible_host'] }}"
    k3s_token: "{{ hostvars[groups['k3s_master'][0]]['k3s_token'] }}"
  
  tasks:
    - name: Display worker node information
      debug:
        msg: "Installing K3s agent on {{ inventory_hostname }} ({{ ansible_host }})"
    
    - name: Check if K3s agent is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_agent_binary
    
    - name: Download K3s installation script
      get_url:
        url: "{{ k3s_install_script_url }}"
        dest: /tmp/k3s-install.sh
        mode: '0755'
      when: not k3s_agent_binary.stat.exists
    
    - name: Install K3s agent
      shell: |
        INSTALL_K3S_VERSION={{ k3s_version }} \
        K3S_URL=https://{{ k3s_master_ip }}:6443 \
        K3S_TOKEN={{ k3s_token }} \
        /tmp/k3s-install.sh agent {{ k3s_agent_options | default([]) | join(' ') }}
      args:
        creates: /usr/local/bin/k3s
      register: k3s_agent_install
      changed_when: k3s_agent_install.rc == 0
    
    - name: Wait for K3s agent to be ready
      systemd:
        name: k3s-agent
        state: started
        enabled: true
      register: k3s_agent_service
      until: k3s_agent_service.status.ActiveState == "active"
      retries: 30
      delay: 10

- name: Verify K3s cluster
  hosts: k3s_master
  become: true
  gather_facts: false
  
  tasks:
    - name: Wait for all nodes to be ready
      shell: |
        k3s kubectl get nodes --no-headers | grep -v "NotReady" | wc -l
      register: ready_nodes
      until: ready_nodes.stdout | int == groups['k3s_cluster'] | length
      retries: 30
      delay: 10
      changed_when: false
    
    - name: Get all nodes
      shell: k3s kubectl get nodes -o wide
      register: all_nodes
      changed_when: false
    
    - name: Display all nodes
      debug:
        msg: "{{ all_nodes.stdout_lines }}"
    
    - name: Get all pods
      shell: k3s kubectl get pods --all-namespaces
      register: all_pods
      changed_when: false
    
    - name: Display all pods
      debug:
        msg: "{{ all_pods.stdout_lines }}"
    
    - name: Display success message
      debug:
        msg: |
          âœ… K3s cluster installed successfully!
          
          Master: {{ hostvars[groups['k3s_master'][0]]['inventory_hostname'] }} ({{ hostvars[groups['k3s_master'][0]]['ansible_host'] }})
          Workers: {{ groups['k3s_workers'] | length }}
          
          To use the cluster, run:
          export KUBECONFIG={{ lookup('env', 'HOME') }}/.kube/config-k3s-local
          kubectl get nodes
