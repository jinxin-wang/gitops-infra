# ç²¾ç®€CI/CDæ¶æ„è®¾è®¡æ–¹æ¡ˆï¼ˆåˆæœŸMVPç‰ˆï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** 10ä¸ªå¾®æœåŠ¡ + 3-4å°äº‘æœåŠ¡å™¨ + åˆæœŸé¡¹ç›®  
**è®¾è®¡åŸåˆ™ï¼š** å¿«é€Ÿä¸Šçº¿ â†’ é¿å…è¿‡åº¦è®¾è®¡ â†’ æŒ‰éœ€æ¼”è¿›  
**ç›®æ ‡ï¼š** 6ä¸ªæœˆå†…å¿«é€ŸéªŒè¯ä¸šåŠ¡ï¼ŒåŒæ—¶ä¿ç•™æœªæ¥æ‰©å±•ç©ºé—´

---

## ç›®å½•
- [1. æ•´ä½“æ¶æ„](#1-æ•´ä½“æ¶æ„)
- [2. æ ¸å¿ƒç†å¿µ](#2-æ ¸å¿ƒç†å¿µ)
- [3. ç¯å¢ƒåˆ’åˆ†](#3-ç¯å¢ƒåˆ’åˆ†)
- [4. ç»„ä»¶é€‰å‹](#4-ç»„ä»¶é€‰å‹)
- [5. åŸºç¡€è®¾æ–½](#5-åŸºç¡€è®¾æ–½)
- [6. æµç¨‹è®¾è®¡](#6-æµç¨‹è®¾è®¡)
- [7. æˆæœ¬ä¸æ€§èƒ½](#7-æˆæœ¬ä¸æ€§èƒ½)
- [8. å®æ–½è·¯çº¿](#8-å®æ–½è·¯çº¿)
- [9. é£é™©ä¸åº”å¯¹](#9-é£é™©ä¸åº”å¯¹)
- [10. æœªæ¥æ¼”è¿›](#10-æœªæ¥æ¼”è¿›)

---

## 1. æ•´ä½“æ¶æ„

### 1.1 æ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»£ç ç®¡ç† (GitLab)                          â”‚
â”‚              (SaaS æˆ– Self-hosted å¯é€‰)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         GitLab CI (Runner on K3s Cluster)                    â”‚
â”‚  â€¢ è§¦å‘CIæµç¨‹  â€¢ æ‰§è¡Œæ„å»º  â€¢ æ¨é€é•œåƒåˆ°Harbor                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å•ä¸ªK3sé›†ç¾¤ (3èŠ‚ç‚¹ï¼Œå…±24GBå†…å­˜)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Namespace: platform    Namespace: dev    Namespace: staging  â”‚
â”‚ â”œâ”€ Harbor              â”œâ”€ App Services   â””â”€ App Services     â”‚
â”‚ â”œâ”€ ArgoCD              â”œâ”€ PostgreSQL                          â”‚
â”‚ â”œâ”€ Prometheus          â”œâ”€ Redis                              â”‚
â”‚ â”œâ”€ Grafana             â””â”€ Testing                            â”‚
â”‚ â””â”€ Cert-Manager                                              â”‚
â”‚                       Namespace: production                  â”‚
â”‚                       â””â”€ App Services (ç‹¬ç«‹ç£ç›˜/ç½‘ç»œ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            GitOps ä»“åº“ (ArgoCD ç›‘æ§)                         â”‚
â”‚  â€¢ åº”ç”¨é…ç½®ç‰ˆæœ¬æ§åˆ¶  â€¢ é…ç½®ä¸ä»£ç åˆ†ç¦»  â€¢ å¿«é€Ÿå›æ»š             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 éƒ¨ç½²é«˜å±‚æµç¨‹

```
1. å¼€å‘è€… git push / merge PR
        â†“
2. GitLab Webhook è§¦å‘ CI æµç¨‹
        â†“
3. GitLab Runner æ‰§è¡Œï¼š
   â”œâ”€ å•å…ƒæµ‹è¯•
   â”œâ”€ ä»£ç æ£€æŸ¥ (SonarCloud)
   â”œâ”€ æ„å»ºDockeré•œåƒ
   â””â”€ æ¨é€åˆ° Harbor
        â†“
4. CI æµç¨‹æ›´æ–° GitOps ä»“åº“ (æ›´æ–°é•œåƒæ ‡ç­¾)
        â†“
5. ArgoCD æ£€æµ‹åˆ°å˜æ›´ï¼Œè‡ªåŠ¨éƒ¨ç½²åˆ°ç›¸åº”ç¯å¢ƒ
        â†“
6. ç›‘æ§å’Œæ—¥å¿—è‡ªåŠ¨æ”¶é›†
```

---

## 2. æ ¸å¿ƒç†å¿µ

### 2.1 ç®€å•èƒœäºå®Œç¾

| ç»´åº¦ | åŸæ¶æ„ | ç²¾ç®€æ–¹æ¡ˆ | åŸå›  |
|------|--------|---------|------|
| **é›†ç¾¤æ•°é‡** | 4ä¸ª | 1ä¸ª | å•é›†ç¾¤å¯æ”¯æ’‘åˆ°30ä¸ªå¾®æœåŠ¡ |
| **ç®¡ç†å·¥å…·** | Rancher | kubectl | 1ä¸ªé›†ç¾¤ä¸éœ€è¦Rancher |
| **CIå¼•æ“** | BuildKite + Tekton | GitLab CI | å‡å°‘ç»´æŠ¤è´Ÿæ‹…ï¼ŒåŠŸèƒ½è¶³å¤Ÿ |
| **ä¾èµ–åŒ…ä»“åº“** | Nexus | Harborä»£ç† | Harboræœ‰ä»£ç†åŠŸèƒ½ |
| **æ„å»ºç³»ç»Ÿ** | Bazel | Docker Build | 10ä¸ªå¾®æœåŠ¡ä¸éœ€è¦Bazel |
| **ç›‘æ§** | 3å±‚åˆ†å±‚ | å•å±‚æœ¬åœ° | åˆæœŸPrometheus + Grafanaè¶³å¤Ÿ |
| **é“¾è·¯è¿½è¸ª** | Jaeger | æš‚ä¸å¼•å…¥ | ç­‰æœåŠ¡>30ä¸ªå†è€ƒè™‘ |

### 2.2 æˆæœ¬ä¼˜å…ˆ

**åŸºç¡€è®¾æ–½æˆæœ¬ï¼š**
```
3å° 4C8G äº‘æœåŠ¡å™¨ (è…¾è®¯äº‘/é˜¿é‡Œäº‘): Â¥2000-3000/æœˆ
æ€»æˆæœ¬: Â¥24000-36000/å¹´
```

**äººåŠ›æŠ•å…¥ï¼š**
- 1ä¸ªå…¨èŒè¿ç»´ (ç®¡ç†K8sã€Harborã€ArgoCD)
- 1ä¸ªå…¼èŒå¼€å‘ (ç¼–å†™CIè„šæœ¬ã€ç›‘æ§å‘Šè­¦)

**ä¸èŠ±é’±çš„éƒ¨åˆ†ï¼š**
- GitLab (å¯ç”¨CEå¼€æºç‰ˆ)
- ArgoCD (å¼€æº)
- Prometheus/Grafana (å¼€æº)
- K3s (å¼€æºï¼Œæ¯”K8sè½»é‡)

### 2.3 å¿«é€Ÿè¿­ä»£

ä»æœ€å°MVPå¼€å§‹ï¼Œé€æ­¥å®Œå–„ï¼š

```
Week 1-2: åŸºç¡€è®¾æ–½æ­å»º (K3s + Harbor + ArgoCD)
    â†“
Week 3-4: è¿ç§»ç¬¬1ä¸ªå¾®æœåŠ¡ï¼ŒéªŒè¯æµç¨‹
    â†“
Week 5-6: è¿ç§»å‰©ä½™å¾®æœåŠ¡
    â†“
Week 7-8: ä¼˜åŒ–å’Œæ–‡æ¡£
    â†“
Month 3+: æ ¹æ®å®é™…æƒ…å†µè¿­ä»£ï¼ˆæ·»åŠ æ–°åŠŸèƒ½ã€æ€§èƒ½ä¼˜åŒ–ï¼‰
```

---

## 3. ç¯å¢ƒåˆ’åˆ†

### 3.1 ä¸‰ç¯å¢ƒè®¾è®¡

```yaml
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¯å¢ƒ             â”‚ Namespace    â”‚ ç”¨é€”          â”‚ èµ„æºè§„æ ¼     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Development      â”‚ dev          â”‚ æ‰€æœ‰åˆ†æ”¯éƒ½    â”‚ requests:    â”‚
â”‚                  â”‚              â”‚ éƒ¨ç½²åˆ°è¿™é‡Œ    â”‚ 0.2C 256M    â”‚
â”‚                  â”‚              â”‚ (æœ€å°åŒ–)      â”‚ limits:      â”‚
â”‚                  â”‚              â”‚              â”‚ 0.5C 512M    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Staging          â”‚ staging      â”‚ mainåˆ†æ”¯      â”‚ requests:    â”‚
â”‚                  â”‚              â”‚ é€šè¿‡çš„ä»£ç     â”‚ 0.5C 512M    â”‚
â”‚                  â”‚              â”‚ (å®Œæ•´é…ç½®)    â”‚ limits:      â”‚
â”‚                  â”‚              â”‚              â”‚ 1C 1Gi       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Production       â”‚ production   â”‚ ç”Ÿäº§æµé‡      â”‚ requests:    â”‚
â”‚                  â”‚              â”‚ (é«˜å¯ç”¨)      â”‚ 1C 2Gi       â”‚
â”‚                  â”‚              â”‚              â”‚ limits:      â”‚
â”‚                  â”‚              â”‚              â”‚ 2C 4Gi       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 åˆ†æ”¯ä¸ç¯å¢ƒçš„å¯¹åº”å…³ç³»

```
Feature Branch
    â†“ Create PR
    â†“ (CIè¿è¡Œæµ‹è¯•)
    â†“
dev åˆ†æ”¯ â†’ Deploy to dev namespace â†’ QAæµ‹è¯•
    â†“ (é€šè¿‡QA)
    â†“ Merge to main
main åˆ†æ”¯ â†’ Deploy to staging namespace â†’ UAT
    â†“ (é€šè¿‡UATï¼Œæ‰‹åŠ¨æ‰¹å‡†)
    â†“ Create Release Tag
release-* â†’ Deploy to production â†’ ç”¨æˆ·è®¿é—®
```

### 3.3 ä½•æ—¶æ¸…ç†ç¯å¢ƒ

| ç¯å¢ƒ | ä¿ç•™ç­–ç•¥ | æ¸…ç†ç­–ç•¥ |
|------|---------|---------|
| **dev** | æŒç»­ä¿ç•™ï¼Œå®æ—¶æ›´æ–° | æ‰‹åŠ¨åˆ é™¤ï¼ˆç£ç›˜æ»¡æ—¶ï¼‰ |
| **staging** | æŒç»­ä¿ç•™ï¼Œä»…mainåˆ†æ”¯æ›´æ–° | æ‰‹åŠ¨æ¸…ç†ï¼ˆä¿ç•™æœ€è¿‘10ä¸ªç‰ˆæœ¬ï¼‰ |
| **production** | æŒç»­ä¿ç•™ | ç‰ˆæœ¬ç®¡ç†ï¼ˆä¿ç•™æœ€è¿‘20ä¸ªç‰ˆæœ¬ï¼‰ |

---

## 4. ç»„ä»¶é€‰å‹

### 4.1 åŸºç¡€è®¾æ–½

```
æ“ä½œç³»ç»Ÿ: Ubuntu 20.04 LTS (äº‘æœåŠ¡å™¨è‡ªå¸¦)
    â†“
K3s (Kubernetes å‘è¡Œç‰ˆ)
â”œâ”€ ç‰¹ç‚¹: è½»é‡çº§ (<1GBå†…å­˜), ä¸€é”®å®‰è£…
â”œâ”€ æ›¿ä»£å“: K8s (ä½†å¤ªé‡ï¼Œä¸æ¨è)
â””â”€ å®‰è£…: curl -sfL https://get.k3s.io | sh -
    â†“
Helm (åŒ…ç®¡ç†å·¥å…·)
â”œâ”€ ç”¨é€”: å®‰è£…æ‰€æœ‰ç¬¬ä¸‰æ–¹æœåŠ¡
â””â”€ å®‰è£…: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```

### 4.2 ä»£ç ä»“åº“

```
é€‰é¡¹1: GitLab CE (æ¨è)
â”œâ”€ åŠŸèƒ½: å®Œæ•´çš„Git + CI/CD + Container Registry
â”œâ”€ èµ„æº: ~1.5GBå†…å­˜ (shared_buffersè¾ƒä½æ—¶)
â”œâ”€ ç»´æŠ¤: æ¯æœˆè‡ªåŠ¨å‡çº§
â””â”€ éƒ¨ç½²: Helm Chart (gitlab/gitlab-ce)

é€‰é¡¹2: GitHub + GitHub Actions
â”œâ”€ ä¼˜ç‚¹: æ— éœ€è‡ªå»ºï¼Œäº‘ç«¯ç®¡ç†
â”œâ”€ ç¼ºç‚¹: æ²¡æœ‰ç§æœ‰Container Registryï¼Œéœ€è¦Harbor
â””â”€ å»ºè®®: å°å›¢é˜Ÿå¯ç”¨
```

**å»ºè®®ï¼šä½¿ç”¨GitLab CE**

### 4.3 å®¹å™¨é•œåƒä»“åº“

```
Harbor (å¿…é€‰)
â”œâ”€ åŠŸèƒ½: 
â”‚  â”œâ”€ å­˜å‚¨Dockeré•œåƒ
â”‚  â”œâ”€ ä»£ç†PyPI/npm/Go Modç­‰ (æ— éœ€Nexus)
â”‚  â”œâ”€ æ¼æ´æ‰«æ (Trivyé›†æˆ)
â”‚  â””â”€ RBACæƒé™ç®¡ç†
â”œâ”€ èµ„æº: ~0.5GBå†…å­˜ + PostgreSQL
â””â”€ éƒ¨ç½²: Helm Chart (harbor/harbor)
```

### 4.4 CI/CDå¼•æ“

```
GitLab CI Runner (å¿…é€‰)
â”œâ”€ å·¥ä½œåŸç†:
â”‚  â”œâ”€ GitLabå‘é€Webhook
â”‚  â”œâ”€ Runneræ¥æ”¶ä»»åŠ¡
â”‚  â”œâ”€ åœ¨K8s Podä¸­æ‰§è¡Œè„šæœ¬
â”‚  â””â”€ æ¨é€ç»“æœå›GitLab
â”œâ”€ èµ„æºå ç”¨: <100MB (idleçŠ¶æ€)
â”œâ”€ å¹¶å‘èƒ½åŠ›: å¯åŒæ—¶è¿è¡Œ10+ä¸ªPod
â””â”€ éƒ¨ç½²: Helm Chart (gitlab-runner/gitlab-runner)

ä¸ºä»€ä¹ˆä¸ç”¨Tekton?
â”œâ”€ Tektonå¤ªå¤æ‚ï¼Œå­¦ä¹ æ›²çº¿é™¡å³­
â”œâ”€ GitLab CIçš„YAMLé…ç½®æ›´ç®€å•
â””â”€ åŠŸèƒ½è¶³å¤Ÿåº”ä»˜10ä¸ªå¾®æœåŠ¡
```

### 4.5 GitOpséƒ¨ç½²å¼•æ“

```
ArgoCD (å¿…é€‰)
â”œâ”€ èŒè´£:
â”‚  â”œâ”€ æŒç»­ç›‘æ§GitOpsä»“åº“
â”‚  â”œâ”€ è‡ªåŠ¨åŒæ­¥åº”ç”¨åˆ°K8s
â”‚  â”œâ”€ æä¾›Web UIæŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
â”‚  â””â”€ æ”¯æŒå¿«é€Ÿå›æ»š
â”œâ”€ èµ„æº: ~0.3GBå†…å­˜
â”œâ”€ é…ç½®: Kustomize (æ— éœ€Helm)
â””â”€ éƒ¨ç½²: Helm Chart (argo/argo-cd)
```

### 4.6 ç›‘æ§ä¸æ—¥å¿—

#### ç›‘æ§æ–¹æ¡ˆï¼ˆä¸‰é€‰ä¸€ï¼‰

**æ–¹æ¡ˆAï¼šæœ€å°åŒ–ç›‘æ§ï¼ˆå¯åŠ¨é˜¶æ®µæ¨èï¼‰**
```
äº‘å‚å•†ç›‘æ§ + metrics-server
â”œâ”€ äº‘å‚å•†ç›‘æ§ (è…¾è®¯äº‘/é˜¿é‡Œäº‘):
â”‚  â”œâ”€ æœåŠ¡å™¨çº§åˆ«ç›‘æ§ (CPU/å†…å­˜/ç£ç›˜)
â”‚  â”œâ”€ åŸºç¡€å‘Šè­¦èƒ½åŠ›
â”‚  â””â”€ èµ„æº: 0 (äº‘ç«¯)
â”‚
â””â”€ metrics-server:
   â”œâ”€ æä¾› kubectl top å‘½ä»¤
   â”œâ”€ K8såŸºç¡€èµ„æºç›‘æ§
   â””â”€ èµ„æº: ~50MBå†…å­˜

éƒ¨ç½²æ–¹å¼:
  kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

ä¼˜ç‚¹: 
  âœ… æä½èµ„æºå ç”¨
  âœ… é›¶ç»´æŠ¤æˆæœ¬
  âœ… æ»¡è¶³åˆæœŸç›‘æ§éœ€æ±‚
ç¼ºç‚¹:
  âŒ æ— å¯è§†åŒ–ç•Œé¢
  âŒ æ— å†å²æ•°æ®å­˜å‚¨
```

**æ–¹æ¡ˆBï¼šè½»é‡çº§ç›‘æ§ï¼ˆå¹³è¡¡æ–¹æ¡ˆï¼‰**
```
äº‘å‚å•†ç›‘æ§ + Prometheus (æ— Grafana)
â”œâ”€ Prometheus:
â”‚  â”œâ”€ æ”¶é›†K8sèŠ‚ç‚¹ã€Podçš„æŒ‡æ ‡
â”‚  â”œâ”€ æä¾›åŸºç¡€æŸ¥è¯¢ç•Œé¢
â”‚  â”œâ”€ æ”¯æŒå‘Šè­¦è§„åˆ™
â”‚  â””â”€ èµ„æº: ~0.5GBå†…å­˜
â”‚
â””â”€ äº‘å‚å•†ç›‘æ§:
   â””â”€ æœåŠ¡å™¨å±‚é¢ç›‘æ§

éƒ¨ç½²æ–¹å¼:
  helm install prometheus prometheus-community/prometheus \
    -n monitoring --set grafana.enabled=false

ä¼˜ç‚¹:
  âœ… æœ‰å†å²æ•°æ®å­˜å‚¨
  âœ… èµ„æºå ç”¨é€‚ä¸­
  âœ… æ”¯æŒå‘Šè­¦
ç¼ºç‚¹:
  âŒ æŸ¥è¯¢ç•Œé¢ç®€é™‹
```

**æ–¹æ¡ˆCï¼šå®Œæ•´ç›‘æ§ï¼ˆé•¿æœŸæ¨èï¼‰**
```
Prometheus + Grafana
â”œâ”€ Prometheus:
â”‚  â”œâ”€ æ”¶é›†K8sèŠ‚ç‚¹ã€Podçš„æŒ‡æ ‡
â”‚  â”œâ”€ æ”¶é›†åº”ç”¨è‡ªå®šä¹‰æŒ‡æ ‡
â”‚  â”œâ”€ æ”¯æŒå¤æ‚å‘Šè­¦è§„åˆ™
â”‚  â””â”€ èµ„æº: ~0.5GBå†…å­˜
â”‚
â””â”€ Grafana:
   â”œâ”€ å¼ºå¤§çš„å¯è§†åŒ–èƒ½åŠ›
   â”œâ”€ ä¸°å¯Œçš„Dashboardæ¨¡æ¿
   â”œâ”€ å¤šæ•°æ®æºæ”¯æŒ
   â””â”€ èµ„æº: ~0.2GBå†…å­˜

éƒ¨ç½²æ–¹å¼:
  helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring

ä¼˜ç‚¹:
  âœ… åŠŸèƒ½å®Œæ•´
  âœ… å¯è§†åŒ–å¼ºå¤§
  âœ… è¡Œä¸šæ ‡å‡†
ç¼ºç‚¹:
  âŒ å ç”¨0.7GBå†…å­˜
```

**å»ºè®®è·¯çº¿ï¼š**
```
Month 1-2: æ–¹æ¡ˆA (æœ€å°åŒ–) â†’ å¿«é€Ÿå¯åŠ¨
Month 3+:  æ–¹æ¡ˆC (å®Œæ•´)   â†’ ç¨³å®šè¿è¡Œåå‡çº§
```

#### æ—¥å¿—æ–¹æ¡ˆï¼ˆä¸‰é€‰ä¸€ï¼‰

```
ä¸ºä»€ä¹ˆåˆæœŸä¸ç”¨ELK/Loki?
â”œâ”€ åº”ç”¨å°‘ï¼Œæ—¥å¿—é‡å°
â”œâ”€ kubectl logs è¶³å¤Ÿ
â”œâ”€ äº‘å‚å•†æä¾›æ—¥å¿—æœåŠ¡
â””â”€ ç­‰æ—¥å¿—é‡>100GB/å¤©å†å‡çº§

é€‰é¡¹1: äº‘å‚å•†æ—¥å¿—æœåŠ¡ (æ¨èï¼Œæ— éœ€ç»´æŠ¤)
é€‰é¡¹2: kubectl logs (æç®€ï¼Œåº”æ€¥å¤Ÿç”¨)
é€‰é¡¹3: è‡ªå»ºLoki (éœ€è¦é¢å¤–èµ„æºï¼Œæš‚ä¸æ¨è)
```

### 4.7 å®Œæ•´æœåŠ¡æ¸…å•

#### é…ç½®æ–¹æ¡ˆå¯¹æ¯”

**æœ€å°åŒ–é…ç½®ï¼ˆå¯åŠ¨é˜¶æ®µï¼‰ï¼š**
| æœåŠ¡ | èµ„æºå ç”¨ | æ˜¯å¦å¿…éœ€ | éƒ¨ç½²æ–¹å¼ |
|------|---------|---------|---------|
| K3s Master | 2GB | âœ… | äº‘æœåŠ¡å™¨1 |
| K3s Worker | 6GB (shared) | âœ… | äº‘æœåŠ¡å™¨2-3 |
| GitLab CE | 1.5GB | âœ… | K3s Pod |
| Harbor | 1GB | âœ… | K3s Pod |
| GitLab Runner | 0.1GB | âœ… | K3s Pod |
| ArgoCD | 0.3GB | âœ… | K3s Pod |
| metrics-server | 0.05GB | âœ… | K3s Pod |
| Cert-Manager | 0.1GB | âœ… | K3s Pod |
| **æ€»è®¡** | **â‰ˆ11GB** | â€” | **é€‚åˆ3å°4C8G** |

**å®Œæ•´é…ç½®ï¼ˆç¨³å®šè¿è¡Œåï¼‰ï¼š**
| æœåŠ¡ | èµ„æºå ç”¨ | æ˜¯å¦å¿…éœ€ | éƒ¨ç½²æ–¹å¼ |
|------|---------|---------|---------|
| K3s Master | 2GB | âœ… | äº‘æœåŠ¡å™¨1 |
| K3s Worker | 6GB (shared) | âœ… | äº‘æœåŠ¡å™¨2-3 |
| GitLab CE | 1.5GB | âœ… | K3s Pod |
| Harbor | 1GB | âœ… | K3s Pod |
| GitLab Runner | 0.1GB | âœ… | K3s Pod |
| ArgoCD | 0.3GB | âœ… | K3s Pod |
| Prometheus | 0.5GB | ğŸ“Š æ¨è | K3s Pod |
| Grafana | 0.2GB | ğŸ“Š æ¨è | K3s Pod |
| Cert-Manager | 0.1GB | âœ… | K3s Pod |
| **æ€»è®¡** | **â‰ˆ12GB** | â€” | **é€‚åˆ3å°4C8G** |

**è¯´æ˜ï¼š**
- âœ… å¿…éœ€ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»éƒ¨ç½²
- ğŸ“Š æ¨èï¼šå¼ºçƒˆå»ºè®®éƒ¨ç½²ï¼Œä½†å¯å»¶ååˆ°Month 3+

---

## 5. åŸºç¡€è®¾æ–½

### 5.1 äº‘æœåŠ¡å™¨é…ç½®

```yaml
äº‘æœåŠ¡å•†: è…¾è®¯äº‘ TKE (æ¨è) æˆ– é˜¿é‡Œäº‘ ACK æˆ– AWS EKS

æœåŠ¡å™¨è§„æ ¼:
  Server-1 (K3s Master + Harbor):
    CPU: 4æ ¸
    å†…å­˜: 8GB
    ç£ç›˜: 100GB SSD
    å¸¦å®½: 5Mbps
  
  Server-2 & Server-3 (K3s Worker):
    CPU: 4æ ¸ (æ¯ä¸ª)
    å†…å­˜: 8GB (æ¯ä¸ª)
    ç£ç›˜: 100GB SSD (æ¯ä¸ª)
    å¸¦å®½: 5Mbps

æ€»æˆæœ¬: Â¥2000-3000/æœˆ (æŒ‰ä½¿ç”¨é‡è®¡è´¹)
```

### 5.2 å­˜å‚¨æ–¹æ¡ˆ

```
Podå­˜å‚¨ (ä¸´æ—¶):
  â””â”€ K3sé»˜è®¤ (local storage)
    â”œâ”€ ç”¨äº: åº”ç”¨Podçš„å·¥ä½œæ–‡ä»¶
    â””â”€ ç‰¹ç‚¹: Podåˆ é™¤åè‡ªåŠ¨æ¸…ç†

æŒä¹…åŒ–å­˜å‚¨:
  â”œâ”€ æ•°æ®åº“ (PostgreSQL/MySQL):
    â”‚  â””â”€ æ–¹æ¡ˆ1: äº‘å‚å•†æ‰˜ç®¡RDS (æ¨èï¼Œæ— éœ€ç»´æŠ¤)
    â”‚  â””â”€ æ–¹æ¡ˆ2: Podå†…è¿è¡Œæ•°æ®åº“ (ç®€å•ä½†æœ‰é£é™©)
    â”‚
  â”œâ”€ Harboré•œåƒå­˜å‚¨:
    â”‚  â””â”€ æ–¹æ¡ˆ1: äº‘å‚å•†å¯¹è±¡å­˜å‚¨ (S3/OSS, æ¨è)
    â”‚  â””â”€ æ–¹æ¡ˆ2: æœ¬åœ°SSD (éœ€è¦å¤‡ä»½è®¡åˆ’)
    â”‚
  â””â”€ å¤‡ä»½:
     â””â”€ ç”¨Veleroè‡ªåŠ¨å¤‡ä»½etcd + åº”ç”¨æ•°æ®
```

### 5.3 ç½‘ç»œé…ç½®

```
DNS: äº‘å‚å•†æä¾› (å¦‚æœè‡ªå»ºGitLabéœ€è¦åŸŸå)
  â”œâ”€ åˆ†é…ä¸€ä¸ªåŸŸå (ä¾‹å¦‚: gitlab.mycompany.com)
  â””â”€ é…ç½®CNAMEæŒ‡å‘è´Ÿè½½å‡è¡¡å™¨

è´Ÿè½½å‡è¡¡:
  â”œâ”€ K3så†…ç½® (é»˜è®¤ç”¨Service NodePort)
  â””â”€ æˆ–ç”¨äº‘å‚å•†SLB + Ingress Controller

é˜²ç«å¢™è§„åˆ™:
  â”œâ”€ å…¥ç«™: 80/443 (HTTP/HTTPS) å¯¹æ‰€æœ‰
  â”œâ”€ å…¥ç«™: 22 (SSH) ä»…è¿ç»´ç½‘ç»œ
  â””â”€ å‡ºç«™: å…¨éƒ¨å…è®¸ (æ‹‰å–ä¾èµ–åŒ…)

VPN (å¯é€‰):
  â”œâ”€ å¦‚éœ€è®¿é—®æœ¬åœ°æ•°æ®åº“ï¼Œé…ç½®VPN
  â””â”€ åˆæœŸå¯ä¸é…ï¼Œå…ˆç”¨äº‘ç«¯èµ„æº
```

### 5.4 å®‰å…¨é…ç½®

```
è¯ä¹¦ç®¡ç†:
  â””â”€ Cert-Manager + Let's Encrypt
    â”œâ”€ è‡ªåŠ¨ç”³è¯·HTTPSè¯ä¹¦
    â”œâ”€ è‡ªåŠ¨ç»­æœŸ
    â””â”€ æ— éœ€æ‰‹åŠ¨ç»´æŠ¤

å¯†é’¥ç®¡ç†:
  â”œâ”€ K8s Secrets (åˆæœŸç”¨è¿™ä¸ª)
  â”‚  â””â”€ å­˜å‚¨æ•°æ®åº“å¯†ç ã€é•œåƒæ‹‰å–å‡­è¯ç­‰
  â”‚
  â”œâ”€ Sealed Secrets (æ¨èå‡çº§åˆ°è¿™ä¸ª)
  â”‚  â””â”€ å¯†é’¥åŠ å¯†å­˜å‚¨åœ¨Gitä¸­
  â”‚
  â””â”€ Vault (ç­‰è§„æ¨¡æ‰©å¤§å†ç”¨)

é•œåƒå®‰å…¨:
  â”œâ”€ Harborå¯ç”¨é•œåƒæ‰«æ (Trivy)
  â”œâ”€ åªå…è®¸æ‹‰å–å·²æ‰«æçš„é•œåƒ
  â””â”€ å®šæœŸæ‰«æå·²éƒ¨ç½²çš„é•œåƒ
```

---

## 6. æµç¨‹è®¾è®¡

### 6.1 CIæµç¨‹è¯¦è§£

```yaml
# .gitlab-ci.yml ç¤ºä¾‹

stages:
  - test
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  REGISTRY: harbor.mycompany.com
  DOCKER_HOST: tcp://docker:2375

# ==================== TESTé˜¶æ®µ ====================
test:unit:
  stage: test
  image: python:3.10
  script:
    - pip install -r requirements.txt
    - pytest tests/ --cov=app
  coverage: '/TOTAL.*\s+(\d+%)$/'
  only:
    - merge_requests
    - main

test:lint:
  stage: test
  image: python:3.10
  script:
    - pip install flake8 black
    - black --check app/
    - flake8 app/
  only:
    - merge_requests
    - main

test:security:
  stage: test
  image: returntocorp/semgrep
  script:
    - semgrep --config=p/owasp-top-ten app/
  allow_failure: true
  only:
    - merge_requests
    - main

# ==================== BUILDé˜¶æ®µ ====================
build:image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    # ç”Ÿæˆé•œåƒæ ‡ç­¾
    - export IMAGE_TAG="${REGISTRY}/myapp:${CI_COMMIT_SHA:0:8}"
    - export IMAGE_TAG_LATEST="${REGISTRY}/myapp:latest"
    
    # æ„å»ºé•œåƒ
    - docker build -t ${IMAGE_TAG} -t ${IMAGE_TAG_LATEST} .
    
    # ç™»å½•Harbor
    - docker login -u ${HARBOR_USERNAME} -p ${HARBOR_PASSWORD} ${REGISTRY}
    
    # æ¨é€é•œåƒ
    - docker push ${IMAGE_TAG}
    - docker push ${IMAGE_TAG_LATEST}
    
    # å¯é€‰: æ‰«æé•œåƒæ¼æ´
    - echo "é•œåƒå·²æ¨é€åˆ°Harborï¼Œæ¼æ´æ‰«æç”±Harborè‡ªåŠ¨æ‰§è¡Œ"
  only:
    - main
    - tags

# ==================== DEPLOYé˜¶æ®µ ====================
deploy:dev:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    # æ›´æ–°dev namespaceçš„éƒ¨ç½²
    - kubectl set image deployment/myapp 
        myapp=${REGISTRY}/myapp:${CI_COMMIT_SHA:0:8} 
        -n dev
    
    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    - kubectl rollout status deployment/myapp -n dev
  environment:
    name: dev
    kubernetes:
      namespace: dev
  only:
    - main
  when: manual

deploy:staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    # æ›´æ–°staging namespace
    - kubectl set image deployment/myapp 
        myapp=${REGISTRY}/myapp:${CI_COMMIT_SHA:0:8} 
        -n staging
    
    - kubectl rollout status deployment/myapp -n staging
  environment:
    name: staging
    kubernetes:
      namespace: staging
  only:
    - main
  when: manual

deploy:production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    # æ›´æ–°production namespace
    - kubectl set image deployment/myapp 
        myapp=${REGISTRY}/myapp:${CI_COMMIT_SHA:0:8} 
        -n production
    
    - kubectl rollout status deployment/myapp -n production
  environment:
    name: production
    kubernetes:
      namespace: production
  only:
    - tags
  when: manual
```

### 6.2 GitOpsæµç¨‹è¯¦è§£

**æ–¹æ¡ˆ1ï¼šç›´æ¥ç”¨kubectl (ç®€å•)**
```bash
# éƒ¨ç½²åº”ç”¨
kubectl apply -f k8s/deployment.yaml -n dev

# æŸ¥çœ‹çŠ¶æ€
kubectl get deployment -n dev

# å›æ»š
kubectl rollout undo deployment/myapp -n dev
```

**æ–¹æ¡ˆ2ï¼šç”¨Kustomize + ArgoCD (æ¨è)**

```
gitops-repo/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ configmap.yaml
â”‚
â”œâ”€â”€ overlays/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â””â”€â”€ kustomization.yaml  (replicas: 1)
â”‚   â”‚
â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â””â”€â”€ kustomization.yaml  (replicas: 2)
â”‚   â”‚
â”‚   â””â”€â”€ production/
â”‚       â””â”€â”€ kustomization.yaml  (replicas: 3)
â”‚
â””â”€â”€ argocd/
    â”œâ”€â”€ dev-app.yaml
    â”œâ”€â”€ staging-app.yaml
    â””â”€â”€ production-app.yaml
```

**base/kustomization.yaml:**
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: default

resources:
  - deployment.yaml
  - service.yaml
  - configmap.yaml

images:
  - name: myapp
    newTag: latest  # ArgoCDä¼šè‡ªåŠ¨æ›´æ–°
```

**overlays/dev/kustomization.yaml:**
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
  - ../../base

namespace: dev

replicas:
  - name: myapp
    count: 1

patches:
  - target:
      kind: Deployment
      name: myapp
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "256Mi"
```

**argocd/dev-app.yaml:**
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: myapp-dev
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/mycompany/gitops-repo.git
    targetRevision: main
    path: overlays/dev
  destination:
    server: https://kubernetes.default.svc
    namespace: dev
  syncPolicy:
    automated:
      prune: true      # è‡ªåŠ¨åˆ é™¤ä¸åœ¨Gitä¸­çš„èµ„æº
      selfHeal: true   # è‡ªåŠ¨ä¿®å¤æ¼‚ç§»
    syncOptions:
      - CreateNamespace=true
```

**CIæµç¨‹æ›´æ–°é•œåƒæ ‡ç­¾ï¼š**
```bash
# åœ¨.gitlab-ci.ymlä¸­
- git clone https://github.com/mycompany/gitops-repo.git
- cd gitops-repo
- kustomize edit set image myapp=${REGISTRY}/myapp:${CI_COMMIT_SHA:0:8}
- git add .
- git commit -m "Update image tag to ${CI_COMMIT_SHA:0:8}"
- git push origin main
```

### 6.3 å›æ»šæµç¨‹

**å¿«é€Ÿå›æ»šï¼ˆArgoCDï¼‰ï¼š**
```bash
# æŸ¥çœ‹éƒ¨ç½²å†å²
argocd app history myapp-production

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
argocd app rollback myapp-production

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
argocd app rollback myapp-production 3
```

**å®‰å…¨çš„å›æ»šï¼ˆGitï¼‰ï¼š**
```bash
# GitOpsä»“åº“ä¸­åå‘æäº¤
git revert <commit-hash>
git push origin main

# ArgoCDè‡ªåŠ¨æ£€æµ‹å˜æ›´å¹¶åŒæ­¥
```

---

## 7. æˆæœ¬ä¸æ€§èƒ½

### 7.1 æˆæœ¬åˆ†è§£

```
å›ºå®šæˆæœ¬ (æœˆ):
â”œâ”€ æœåŠ¡å™¨: 3å° 4C8G = Â¥2000-3000
â”œâ”€ å¸¦å®½: 5Mbps = Â¥200-300
â”œâ”€ å­˜å‚¨: 300GB SSD = Â¥100-200
â””â”€ æ•°æ®åº“(RDS): 2GBå­˜å‚¨ = Â¥200-300
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   å°è®¡: Â¥2500-3800/æœˆ

å˜é‡æˆæœ¬:
â”œâ”€ æµé‡è¶…é¢ (åˆæœŸåº”è¯¥ä¸ä¼š)
â”œâ”€ å¤‡ä»½å­˜å‚¨ (åˆæœŸå¯å¿½ç•¥)
â””â”€ Snapshotæˆæœ¬ (åˆæœŸå¯å¿½ç•¥)

å¹´åº¦é¢„ç®—: Â¥30000-45600 (ä¸å«äººåŠ›)
```

### 7.2 èµ„æºåˆ©ç”¨ç‡é¢„æµ‹

```
åˆæœŸ(2-3ä¸ªæœˆ):
â”œâ”€ CPUåˆ©ç”¨ç‡: 20-30% (å……è¶³)
â”œâ”€ å†…å­˜åˆ©ç”¨ç‡: 40-50% (æœ‰ä½™é‡)
â””â”€ ç£ç›˜åˆ©ç”¨ç‡: 30-40% (é•œåƒåº“ä¼šé€æ­¥å¢é•¿)

ä¸­æœŸ(3-6ä¸ªæœˆ):
â”œâ”€ CPUåˆ©ç”¨ç‡: 40-60% (ä»æœ‰ä½™é‡)
â”œâ”€ å†…å­˜åˆ©ç”¨ç‡: 60-70% (éœ€å…³æ³¨)
â””â”€ ç£ç›˜åˆ©ç”¨ç‡: 60-70% (éœ€è¦æ¸…ç†æ—§é•œåƒ)

æ‰©å±•è§¦å‘ç‚¹:
â”œâ”€ CPUæŒç»­>80% â†’ å¢åŠ WorkerèŠ‚ç‚¹
â”œâ”€ å†…å­˜æŒç»­>80% â†’ å¢åŠ å†…å­˜æˆ–ä¼˜åŒ–Podé…ç½®
â””â”€ ç£ç›˜>90% â†’ æ¸…ç†æ—§é•œåƒæˆ–å‡çº§å­˜å‚¨
```

### 7.3 æ€§èƒ½æŒ‡æ ‡ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | è¯´æ˜ |
|------|------|------|
| **CIæµç¨‹è€—æ—¶** | <10åˆ†é’Ÿ | ä»pushåˆ°é•œåƒæ¨é€å®Œæˆ |
| **éƒ¨ç½²è€—æ—¶** | <5åˆ†é’Ÿ | ä»é•œåƒæ¨é€åˆ°åº”ç”¨ready |
| **åº”ç”¨å¯åŠ¨æ—¶é—´** | <30ç§’ | å®¹å™¨å¯åŠ¨åˆ°ready probeé€šè¿‡ |
| **é•œåƒæ‰«æ** | <2åˆ†é’Ÿ | Harboræ¼æ´æ‰«æå®Œæˆ |
| **APIå“åº”æ—¶é—´** | <500ms | P95å»¶è¿Ÿ |
| **ç³»ç»Ÿå¯ç”¨æ€§** | >95% | å…è®¸æ¯æœˆæœ‰å‡ å°æ—¶æ•…éšœ |

---

## 8. å®æ–½è·¯çº¿

### 8.1 é˜¶æ®µ1ï¼šåŸºç¡€è®¾æ–½æ­å»ºï¼ˆç¬¬1-2å‘¨ï¼‰

**ç¬¬1å‘¨ï¼šé‡‡è´­ & åˆå§‹åŒ–**

```bash
# Step 1: é‡‡è´­æœåŠ¡å™¨
- äº‘å‚å•†è´­ä¹°3å°4C8GæœåŠ¡å™¨
- é‡‡è´­åŸŸå1ä¸ª (ä¾‹å¦‚gitlab.mycompany.com)
- é‡‡è´­å¯¹è±¡å­˜å‚¨å®¹é‡ (100GBèµ·)

# Step 2: åˆå§‹åŒ–æœåŠ¡å™¨
- å®‰è£…Ubuntu 20.04 LTS
- é…ç½®åŸºç¡€å®‰å…¨ (é˜²ç«å¢™ã€å¯†é’¥å¯¹)
- å®‰è£…Docker (K3sä¾èµ–)

# Step 3: å®‰è£…K3s
Server-1 (Master):
  curl -sfL https://get.k3s.io | sh -
  export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

Server-2 & Server-3 (Workers):
  curl -sfL https://get.k3s.io | \
    K3S_URL=https://<server-1-ip>:6443 \
    K3S_TOKEN=<token-from-server-1> sh -

# Step 4: éªŒè¯é›†ç¾¤
kubectl get nodes
# åº”è¯¥çœ‹åˆ°3ä¸ªnodeså¤„äºReadyçŠ¶æ€
```

**ç¬¬2å‘¨ï¼šå¹³å°æœåŠ¡éƒ¨ç½²**

```bash
# Step 1: å®‰è£…Helm
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Step 2: æ·»åŠ Helmä»“åº“
helm repo add gitlab https://charts.gitlab.io
helm repo add harbor https://helm.goharbor.io
helm repo add argo https://argoproj.github.io/argo-helm
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Step 3: åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace gitlab
kubectl create namespace harbor
kubectl create namespace argocd
kubectl create namespace monitoring

# Step 4: éƒ¨ç½²Harbor
helm install harbor harbor/harbor \
  -n harbor \
  -f harbor-values.yaml

# Step 5: éƒ¨ç½²GitLab (å¯é€‰ï¼Œä¹Ÿå¯ç”¨å¤–éƒ¨GitLab)
# å¦‚ä½¿ç”¨å¤–éƒ¨GitLabï¼Œè·³è¿‡æ­¤æ­¥

# Step 6: éƒ¨ç½²ArgoCD
helm install argo-cd argo/argo-cd \
  -n argocd \
  --create-namespace

# Step 7: éƒ¨ç½²Prometheus + Grafana
helm install prometheus prometheus-community/kube-prometheus-stack \
  -n monitoring

# Step 8: åˆ›å»ºåº”ç”¨å‘½åç©ºé—´
kubectl create namespace dev
kubectl create namespace staging
kubectl create namespace production
```

### 8.2 é˜¶æ®µ2ï¼šéªŒè¯ä¸ä¼˜åŒ–ï¼ˆç¬¬3-4å‘¨ï¼‰

```bash
# Step 1: è¿ç§»ç¬¬ä¸€ä¸ªå¾®æœåŠ¡ (é€‰æœ€ç®€å•çš„ä¸€ä¸ª)
- ç¼–å†™Dockerfile
- ç¼–å†™.gitlab-ci.yml
- æäº¤ç¬¬ä¸€ä¸ªcommit
- è§‚å¯ŸCIæµç¨‹æ‰§è¡Œæƒ…å†µ
- æ‰‹åŠ¨éƒ¨ç½²åˆ°devç¯å¢ƒ
- éªŒè¯åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ

# Step 2: ä¼˜åŒ–å’Œè°ƒè¯•
- å¦‚æœé•œåƒä½“ç§¯è¿‡å¤§ï¼Œä¼˜åŒ–Dockerfile
- å¦‚æœCIè€—æ—¶è¿‡é•¿ï¼Œåˆ†æç“¶é¢ˆ
- å¦‚æœåº”ç”¨æ— æ³•å¯åŠ¨ï¼Œæ£€æŸ¥Podæ—¥å¿—

# Step 3: ç¼–å†™æ“ä½œæ–‡æ¡£
- K8såŸºç¡€æ“ä½œæŒ‡å—
- CI/CDæµç¨‹è¯´æ˜
- æ•…éšœæ’æŸ¥æŒ‡å—
- å¤‡ä»½æ¢å¤æµç¨‹

# Step 4: å›¢é˜ŸåŸ¹è®­
- è®²è§£æ•´ä½“æ¶æ„
- æ¼”ç¤ºCI/CDæµç¨‹
- æ¼”ç¤ºå›æ»šæ“ä½œ
- ç­”ç–‘å’Œè®¨è®º
```

### 8.3 é˜¶æ®µ3ï¼šå…¨é‡è¿ç§»ï¼ˆç¬¬5-8å‘¨ï¼‰

```
Week 5: è¿ç§»2-3ä¸ªæ ¸å¿ƒå¾®æœåŠ¡
Week 6: è¿ç§»4-6ä¸ªå¾®æœåŠ¡
Week 7: è¿ç§»7-10ä¸ªå¾®æœåŠ¡
Week 8: å®Œæˆæ‰€æœ‰å¾®æœåŠ¡ï¼Œæµ‹è¯•æ‰€æœ‰æµç¨‹

å…³é”®æ£€æŸ¥ç‚¹:
â”œâ”€ æ‰€æœ‰å¾®æœåŠ¡éƒ½èƒ½é€šè¿‡CI
â”œâ”€ æ‰€æœ‰ç¯å¢ƒéƒ½èƒ½è‡ªåŠ¨éƒ¨ç½²
â”œâ”€ ç›‘æ§å’Œå‘Šè­¦æ­£å¸¸å·¥ä½œ
â””â”€ å›¢é˜Ÿèƒ½å¤Ÿç‹¬ç«‹æ“ä½œ
```

### 8.4 ç¬¬ä¸€æœˆçš„ä¼˜å…ˆçº§

```
P0 (å¿…é¡»):
â”œâ”€ K8sé›†ç¾¤æ­å»º
â”œâ”€ Harboréƒ¨ç½²
â”œâ”€ ç¬¬ä¸€ä¸ªå¾®æœåŠ¡è¿ç§»
â””â”€ CIæµç¨‹éªŒè¯

P1 (é‡è¦):
â”œâ”€ æ‰€æœ‰å¾®æœåŠ¡è¿ç§»
â”œâ”€ ArgoCDé…ç½®
â”œâ”€ åŸºç¡€ç›‘æ§

P2 (å¯é€‰):
â”œâ”€ GitLabé«˜å¯ç”¨
â”œâ”€ è¯¦ç»†çš„æ—¥å¿—ç³»ç»Ÿ
â””â”€ æ€§èƒ½ä¼˜åŒ–
```

---

## 9. é£é™©ä¸åº”å¯¹

### 9.1 å¸¸è§é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æ–¹æ¡ˆ |
|------|------|------|---------|
| **K3sé›†ç¾¤å®•æœº** | ä¸­ | é«˜ | 3èŠ‚ç‚¹å¤šå‰¯æœ¬é…ç½®ï¼Œå®šæœŸå¤‡ä»½etcd |
| **Harborå­˜å‚¨æ»¡** | ä¸­ | ä¸­ | å®šæœŸæ¸…ç†æ—§é•œåƒï¼Œè®¾ç½®GCç­–ç•¥ |
| **GitLab CEå‡çº§å¤±è´¥** | ä½ | é«˜ | å‡çº§å‰å¤‡ä»½ï¼Œæµ‹è¯•ç¯å¢ƒå…ˆå‡çº§ |
| **å¯†é’¥æ³„éœ²** | ä½ | ä¸¥é‡ | ä½¿ç”¨Sealed Secretsï¼Œå®šæœŸè½®è½¬ |
| **æ•°æ®åº“è¿æ¥å¤±è´¥** | ä½ | ä¸­ | ä½¿ç”¨RDSæ‰˜ç®¡DBï¼Œå¯ç”¨å¤šAZ |
| **ç£ç›˜ç©ºé—´ä¸è¶³** | ä¸­ | ä¸­ | å®šæœŸç›‘æ§ï¼Œè®¾ç½®å‘Šè­¦ |
| **CIè¶…æ—¶** | ä½ | ä½ | ä¼˜åŒ–æ„å»ºæ­¥éª¤ï¼Œä½¿ç”¨ç¼“å­˜ |
| **ç½‘ç»œåˆ†åŒº** | ä½ | ä¸­ | ä½¿ç”¨äº‘å‚å•†é«˜å¯ç”¨ç½‘ç»œ |

### 9.2 å¤‡ä»½ç­–ç•¥

```yaml
å¤‡ä»½å¯¹è±¡:
â”œâ”€ K8s etcd (é›†ç¾¤é…ç½®): æ¯å¤©å¤‡ä»½åˆ°S3
â”œâ”€ Harboræ•°æ®åº“: æ¯å¤©å¤‡ä»½åˆ°S3
â”œâ”€ GitLabæ•°æ®åº“: æ¯å¤©å¤‡ä»½åˆ°S3
â””â”€ é•œåƒæ•°æ®: ä½¿ç”¨Harborå¤åˆ¶åŠŸèƒ½é•œåƒåˆ°S3

å¤‡ä»½é¢‘ç‡:
â”œâ”€ æ—¥å¤‡ä»½: ç”Ÿäº§å…³é”®æ•°æ®
â”œâ”€ å‘¨å¤‡ä»½: é•¿æœŸä¿ç•™
â””â”€ æœˆå¤‡ä»½: å½’æ¡£

æ¢å¤æµ‹è¯•:
â”œâ”€ æ¯æœˆæ¼”ç»ƒä¸€æ¬¡æ¢å¤æµç¨‹
â”œâ”€ ç¡®ä¿RTO < 1å°æ—¶
â””â”€ è®°å½•æ¢å¤æ­¥éª¤
```

### 9.3 æ•…éšœæ’æŸ¥æ¸…å•

**Podæ— æ³•å¯åŠ¨ï¼š**
```bash
kubectl describe pod <pod-name> -n <namespace>
kubectl logs <pod-name> -n <namespace>
```

**é•œåƒæ¨é€å¤±è´¥ï¼š**
```bash
docker login <harbor-url>
# æ£€æŸ¥Harborç£ç›˜ç©ºé—´
kubectl exec -it harbor-core-xxx -n harbor -- df -h
```

**GitOpsåŒæ­¥å¤±è´¥ï¼š**
```bash
argocd app get <app-name>
argocd app sync <app-name>
```

**é›†ç¾¤ç½‘ç»œä¸é€šï¼š**
```bash
kubectl get svc -n production
# æ£€æŸ¥Service ClusterIPæ˜¯å¦å¯è¾¾
```

---

## 10. æœªæ¥æ¼”è¿›

### 10.1 3-6ä¸ªæœˆçš„å¯èƒ½å‡çº§

å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶è€ƒè™‘å‡çº§ï¼š

```
å‡çº§æ¡ä»¶:
â”œâ”€ å¾®æœåŠ¡æ•°é‡ > 20
â”œâ”€ åŒæ—¶è¿›è¡Œçš„CIä»»åŠ¡ > 5ä¸ª
â”œâ”€ å†…å­˜åˆ©ç”¨ç‡æŒç»­ > 75%
â””â”€ å›¢é˜Ÿäººæ•° > 3äºº

å¯é€‰å‡çº§:
â”œâ”€ æ·»åŠ ç¬¬äºŒä¸ªWorkerèŠ‚ç‚¹ä¸“é—¨ç”¨äºCI
â”œâ”€ å¼•å…¥é•œåƒç¼“å­˜åŠ é€Ÿæ„å»º (Harbor proxy cache)
â”œâ”€ éƒ¨ç½²Sealed SecretsåŠ å¼ºå¯†é’¥ç®¡ç†
â””â”€ é…ç½®Harbor + äº‘å­˜å‚¨åç«¯
```

### 10.2 6-12ä¸ªæœˆçš„å¯èƒ½å‡çº§

```
å‡çº§æ¡ä»¶:
â”œâ”€ å¾®æœåŠ¡æ•°é‡ > 30
â”œâ”€ éƒ¨ç½²é¢‘ç‡ > 50æ¬¡/å¤©
â”œâ”€ éœ€è¦è·¨åœ°åŸŸéƒ¨ç½²
â””â”€ å‡ºç°åˆè§„/å®¡è®¡éœ€æ±‚

å¯èƒ½çš„å‡çº§:
â”œâ”€ åˆ†ç¦»CIå’Œåº”ç”¨é›†ç¾¤
â”œâ”€ å¼•å…¥Service Mesh (åˆçº§: Cilium CNI)
â”œâ”€ é…ç½®å¤šé›†ç¾¤ç®¡ç† (Rancheræˆ–Karmada)
â”œâ”€ éƒ¨ç½²Vaultè¿›è¡Œå¯†é’¥ä¸­å¿ƒåŒ–ç®¡ç†
â””â”€ å®æ–½æ›´ç»†ç²’åº¦çš„RBAC
```

### 10.3 æ¼”è¿›è·¯çº¿å›¾

```
Month 0-2: MVPå®Œæˆ
  â””â”€ å•é›†ç¾¤ + GitLab CI + ArgoCD

Month 2-4: ç¨³å®šè¿è¡Œ
  â””â”€ ä¼˜åŒ–æ€§èƒ½ï¼Œå®Œå–„æ–‡æ¡£

Month 4-6: åˆæ­¥æ‰©å±•
  â”œâ”€ å¯èƒ½æ·»åŠ ç¬¬äºŒä¸ªWorker
  â”œâ”€ å¼•å…¥é•œåƒç¼“å­˜
  â””â”€ æ€§èƒ½ä¼˜åŒ–

Month 6-12: å¤šé›†ç¾¤å‡†å¤‡
  â”œâ”€ è¯„ä¼°æ˜¯å¦éœ€è¦å¤šé›†ç¾¤
  â”œâ”€ è°ƒç ”Rancheræˆ–Karmada
  â””â”€ è§„åˆ’ç¾å¤‡ç­–ç•¥

Month 12+: è§„æ¨¡åŒ–
  â”œâ”€ Stagingç¯å¢ƒç‹¬ç«‹åˆ°æ–°é›†ç¾¤
  â”œâ”€ Productionç¯å¢ƒå¤šAZéƒ¨ç½²
  â”œâ”€ å…¨é¢å®æ–½GitOps + Terraform IaC
  â””â”€ ä¸“ä¸šSREå›¢é˜Ÿæ¥ç®¡è¿ç»´
```

### 10.4 å­¦ä¹ ä¼˜å…ˆçº§

å¦‚æœä½ çš„å›¢é˜Ÿéœ€è¦æå‡æŠ€èƒ½ï¼Œå»ºè®®å­¦ä¹ é¡ºåºï¼š

```
ç¬¬1ä¼˜å…ˆçº§ (å¿…é¡»):
â”œâ”€ DockeråŸºç¡€
â”œâ”€ KubernetesåŸºç¡€æ¦‚å¿µ
â””â”€ kubectlå‘½ä»¤è¡Œ

ç¬¬2ä¼˜å…ˆçº§ (é‡è¦):
â”œâ”€ YAMLæ–‡ä»¶ç¼–å†™
â”œâ”€ Kustomizeé…ç½®ç®¡ç†
â”œâ”€ GitOpsç†å¿µ

ç¬¬3ä¼˜å…ˆçº§ (æ¨è):
â”œâ”€ ArgoCDè¿›é˜¶ç”¨æ³•
â”œâ”€ Helm Charts
â””â”€ K8sæ•…éšœæ’æŸ¥

ç¬¬4ä¼˜å…ˆçº§ (å¯é€‰):
â”œâ”€ Service Mesh (Istio/Cilium)
â”œâ”€ å¯è§‚æµ‹æ€§ (Prometheus/Grafana)
â””â”€ å¤šé›†ç¾¤ç®¡ç† (Rancher)
```

---

## 11. å¿«é€Ÿå‚è€ƒ

### 11.1 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

```bash
# ========== é›†ç¾¤ç®¡ç† ==========
kubectl get nodes                          # æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹
kubectl describe node <node-name>          # æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ…
kubectl top nodes                          # æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ

# ========== Podç®¡ç† ==========
kubectl get pods -n <namespace>            # åˆ—å‡ºå‘½åç©ºé—´å†…çš„Pod
kubectl describe pod <pod-name>            # æŸ¥çœ‹Podè¯¦æƒ…
kubectl logs <pod-name>                    # æŸ¥çœ‹Podæ—¥å¿—
kubectl exec -it <pod-name> -- bash        # è¿›å…¥Podå®¹å™¨
kubectl delete pod <pod-name> -n <ns>      # åˆ é™¤Pod

# ========== éƒ¨ç½²ç®¡ç† ==========
kubectl apply -f deployment.yaml           # åº”ç”¨é…ç½®
kubectl rollout status deployment/<name>   # æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl rollout undo deployment/<name>     # å›æ»šéƒ¨ç½²
kubectl set image deployment/<name> <image> # æ›´æ–°é•œåƒ

# ========== æ•…éšœæ’æŸ¥ ==========
kubectl get events -n <namespace>          # æŸ¥çœ‹äº‹ä»¶
kubectl describe deployment <name>         # æŸ¥çœ‹éƒ¨ç½²è¯¦æƒ…
kubectl get pvc -n <namespace>             # æŸ¥çœ‹æŒä¹…åŒ–å·

# ========== ArgoCDå‘½ä»¤ ==========
argocd app list                            # åˆ—å‡ºåº”ç”¨
argocd app get <app-name>                  # æŸ¥çœ‹åº”ç”¨
argocd app sync <app-name>                 # åŒæ­¥åº”ç”¨
argocd app rollback <app-name>             # å›æ»šåº”ç”¨
```

### 11.2 æ–‡ä»¶æ¨¡æ¿é€ŸæŸ¥è¡¨

**Dockerfile:**
```dockerfile
FROM python:3.10-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "-m", "uvicorn", "app:app", "--host", "0.0.0.0"]
```

**deployment.yaml:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: harbor.mycompany.com/myapp:latest
        ports:
        - containerPort: 8000
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
```

**service.yaml:**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 8000
```

---

## æ€»ç»“

| ç»´åº¦ | ç²¾ç®€æ–¹æ¡ˆ |
|------|---------|
| **é›†ç¾¤æ•°é‡** | 1ä¸ªK3sé›†ç¾¤ |
| **æœåŠ¡å™¨** | 3å°4C8G (Â¥2000-3000/æœˆ) |
| **æ ¸å¿ƒæœåŠ¡** | GitLab CI + Harbor + ArgoCD |
| **ç›‘æ§** | Prometheus + Grafana |
| **å›¢é˜Ÿè§„æ¨¡** | 1-2äºº |
| **æ”¯æŒå¾®æœåŠ¡æ•°** | 10-30ä¸ª |
| **éƒ¨ç½²é¢‘ç‡** | 3-5æ¬¡/å¤© |
| **å›æ»šæ—¶é—´** | <5åˆ†é’Ÿ |
| **ç³»ç»Ÿå¯ç”¨æ€§** | >95% |

è¿™ä¸ªæ–¹æ¡ˆç›¸æ¯”åŸè®¾è®¡**ç®€åŒ–äº†80%**çš„å¤æ‚åº¦ï¼Œä½†ä»ä¿ç•™äº†å®Œæ•´çš„CI/CDèƒ½åŠ›å’Œæœªæ¥æ‰©å±•ç©ºé—´ã€‚

å…³é”®æˆåŠŸå› ç´ ï¼š
1. âœ… å›¢é˜Ÿç†è§£GitOpsç†å¿µ
2. âœ… å»ºç«‹æ¸…æ™°çš„åˆ†æ”¯ç­–ç•¥
3. âœ… å®šæœŸå¤‡ä»½å’Œæµ‹è¯•æ¢å¤
4. âœ… å®Œå–„çš„æ•…éšœæ’æŸ¥æ–‡æ¡£
5. âœ… å¾ªåºæ¸è¿›çš„å­¦ä¹ æ›²çº¿
